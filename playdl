#!/bin/bash
DownloadPreference=$(zenity --list --title="Playdl Configuration" --column="0" "Video and Audio" "Audio Only" "Video Only" "Uninstall (Ubuntu Only)" --width=100 --height=300 --hide-header)
if [ -z "$DownloadPreference" ]; then
		exit 1
fi
GetYouTubeVariables() {
Variables=$(zenity --forms --title="Playdl" --text="Enter playlist/video information" --separator="," --add-entry="Playlist Title" --add-entry="Link" --width=100 --height=300) accepted=$?
	PlayName=$(awk -F, '{print $1}' <<<$Variables)
	PlayLink=$(awk -F, '{print $2}' <<<$Variables)
	DownloadQuality=$(zenity --list --title="Playdl Quality Selection" --column="0" "360" "480" "720" "1080" "Max" --width=100 --height=400 --hide-header)
	if [ -z "$PlayName" ]; then
		exit 1
	fi
	if [ -z "$PlayLink" ]; then
		exit 1
	fi
	Quality="bestaudio[ext=m4a]+bestvideo[height<=$DownloadQuality]"
}
LocateAudio() {
	zenity --info --width=400 --text="Please pick the download location for the audio"
	AudioLocation=$(zenity --file-selection --directory)
}
LocateVideo() {
	zenity --info --width=400 --text="Please pick the download location for the video"
	VideoLocation=$(zenity --file-selection --directory)
}
AudioMode () {
	cd $AudioLocation
	[ -d "$PlayName" ] || mkdir "$PlayName"
	cd "$PlayName"
	(xterm -e youtube-dl -i -c -x --retries infinite -f 'bestaudio[ext=m4a]' --audio-quality 0 --no-overwrites --add-metadata --embed-thumbnail --youtube-skip-dash-manifest -o '%(title)s.%(ext)s' --exec "ffmpeg -i {}  -codec:a libmp3lame -qscale:a 0 {}.mp3 && rm {} " $PlayLink) |
	zenity --progress \
	--title="Downloading audio" \
	--text="Fetching files from YouTube... Close the xterm window to stop the download." \
	--percentage=0 \
	--pulsate \
	--auto-close \
	--auto-kill

}
VideoMode() {
	cd $VideoLocation
	[ -d "$PlayName" ] || mkdir "$PlayName"
	cd "$PlayName"
	(xterm -e youtube-dl -i -c --write-srt -f $Quality --sub-lang en --retries infinite --audio-quality 0 --no-overwrites --add-metadata --youtube-skip-dash-manifest --embed-thumbnail --embed-subs -o '%(title)s.%(ext)s' $PlayLink) |
	zenity --progress \
	--title="Downloading video" \
	--text="Fetching video from YouTube... Close the xterm window to stop the download." \
	--percentage=0 \
	--pulsate \
	--auto-close \
	--auto-kill
}
if [ "$DownloadPreference" == "Video and Audio" ]; then
	GetYouTubeVariables && LocateAudio && LocateVideo && AudioMode && VideoMode
fi
if [ "$DownloadPreference" == "Audio Only" ]; then
	GetYouTubeVariables && LocateAudio && AudioMode
fi

if [ "$DownloadPreference" == "Video Only" ]; then
	GetYouTubeVariables && LocateVideo && VideoMode
fi
if [ "$DownloadPreference" == "Uninstall (Ubuntu Only)" ]; then
sudo rm /usr/bin/playdl
sudo rm /usr/share/applications/Playdl.desktop
fi
notify-send -u low -t 200 -a Playdl "Playdl has finished."
